# 知网爬虫反自动化检测功能说明

## 概述

本项目已集成了完善的反自动化检测系统，通过多层次的技术手段来隐藏自动化特征，提高爬虫的稳定性和成功率。

## 主要功能特性

### 1. 核心反检测机制

#### 1.1 Webdriver 特征隐藏

- **完全移除 webdriver 属性**：删除 navigator.webdriver 及所有相关全局变量
- **清除 Selenium 标识**：移除所有 Selenium 相关的窗口对象
- **隐藏 Playwright 标识**：删除 playwright 相关的全局变量

#### 1.2 浏览器指纹伪装

- **真实用户代理**：使用预设的真实浏览器 User-Agent，不依赖生成器
- **动态屏幕分辨率**：随机选择常见的屏幕分辨率组合
- **完整的浏览器环境**：模拟 Chrome 插件、权限 API、语言设置等
- **硬件信息伪装**：CPU 核心数、平台信息、时区设置

### 2. 网络请求优化

#### 2.1 HTTP 头部增强

```javascript
// 完整的现代浏览器请求头
'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8'
'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6'
'Sec-Ch-Ua': '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"'
'Sec-Fetch-*': 根据请求类型动态设置
```

#### 2.2 网络行为模拟

- **请求拦截和修改**：为所有请求添加真实的安全头
- **随机网络延迟**：模拟真实的网络传输延迟
- **智能请求分类**：根据资源类型设置合适的 Sec-Fetch 属性

### 3. 人类行为模拟系统

#### 3.1 鼠标行为模拟

- **多种行为模式**：阅读模式、浏览模式、搜索模式
- **真实移动轨迹**：带步数的缓慢鼠标移动
- **随机交互**：文本选择、悬停、点击等
- **位置随机化**：在元素范围内随机选择点击位置

#### 3.2 滚动行为优化

- **平滑滚动**：分步执行，模拟真实滚动
- **阅读式滚动**：带停留的小幅度滚动
- **回滚行为**：偶尔向上回滚，模拟真实阅读

#### 3.3 打字行为仿真

```javascript
// 真实的打字速度和模式
- 基础速度：120-180ms/字符
- 速度变化：±30%的随机波动
- 错误模拟：5%概率的打错和修正
- 停顿模式：空格和特殊字符后的额外停顿
```

### 4. 高级伪装技术

#### 4.1 Canvas 指纹混淆

- **像素级噪声**：向 Canvas 添加微量随机噪声
- **动态指纹**：每次运行生成不同的 Canvas 指纹
- **保持功能性**：不影响正常的 Canvas 功能

#### 4.2 事件系统伪装

- **isTrusted 属性**：所有模拟事件标记为 trusted
- **事件包装器**：拦截和包装鼠标键盘事件
- **时序控制**：事件间的真实时间间隔

#### 4.3 多标签页模拟

- **后台标签页**：创建并访问无关网站
- **真实浏览行为**：模拟用户的多标签浏览习惯
- **资源管理**：及时清理后台标签页

### 5. 配置化的反检测等级

#### 5.1 行为模拟等级

```javascript
// 在config.js中配置
BEHAVIOR_SIMULATION_LEVEL: "high"; // low, medium, high
```

#### 5.2 功能开关

```javascript
ADVANCED_OPTIONS: {
    ENABLE_NETWORK_INTERCEPTION: true,    // 网络请求拦截
    ENABLE_BACKGROUND_TABS: true,         // 后台标签页
    USE_REAL_FINGERPRINTS: true,          // 真实指纹
    ENABLE_CANVAS_SPOOFING: true          // Canvas伪装
}
```

### 6. 智能检测与应对

#### 6.1 反爬虫检测

- **页面特征识别**：自动识别验证码、阻止页面
- **URL 模式检测**：识别重定向到阻止页面
- **标题关键词**：检测页面标题中的阻止信息

#### 6.2 自适应应对

- **自动重试**：检测到阻止时自动刷新重试
- **延迟调整**：动态调整操作间隔
- **策略切换**：根据检测结果调整行为模式

### 7. 性能监控

#### 7.1 行为统计

```javascript
// 实时统计用户行为
{
    clickCount: 点击次数,
    scrollCount: 滚动次数,
    typeSpeed: 当前打字速度,
    sessionDuration: 会话时长,
    actionsPerMinute: 每分钟操作数
}
```

#### 7.2 调试信息

- **详细日志**：每个反检测步骤的执行情况
- **配置确认**：启动时显示当前反检测配置
- **错误追踪**：详细的错误信息和处理过程

## 使用说明

### 1. 自动启用

所有反检测功能都会在脚本启动时自动启用，无需额外配置。

### 2. 配置调整

可以在 `src/config.js` 中调整反检测参数：

```javascript
// 调整行为模拟强度
BEHAVIOR_SIMULATION_LEVEL: "high";

// 关闭某些功能（如需要）
ENABLE_NETWORK_INTERCEPTION: false;
```

### 3. 运行验证

启动脚本后会看到类似输出：

```
浏览器初始化完成 - 已启用高级反检测功能
正在注入反检测脚本...
反检测脚本注入完成
设置网络请求拦截...
模拟浏览器标签页操作...
行为数据已重置，新打字速度: 145ms
```

## 技术优势

1. **多层防护**：从浏览器环境、网络请求、用户行为多个层面进行伪装
2. **动态适应**：根据网站检测机制动态调整策略
3. **真实性高**：基于真实用户行为数据进行建模
4. **稳定可靠**：经过充分测试，不影响正常功能
5. **易于维护**：模块化设计，便于更新和扩展

## 注意事项

1. **合规使用**：请确保在合法合规的范围内使用本功能
2. **适度频率**：建议设置合理的访问间隔，避免给目标网站造成过大压力
3. **定期更新**：根据目标网站的反爬虫策略更新，持续优化反检测效果
4. **监控日志**：关注脚本运行日志，及时发现并解决问题

## 更新记录

- **v2.0.0** (2025-01-26): 完整的反自动化检测系统
  - 新增 12 项核心反检测技术
  - 集成人类行为模拟系统
  - 添加网络请求优化
  - 实现配置化的反检测等级
